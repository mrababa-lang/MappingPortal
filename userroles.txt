# SlashData Vehicle Portal - User Roles & Security Logic

This document defines the Role-Based Access Control (RBAC) logic that must be enforced by the backend API.

## 1. Role Definitions

The system supports three distinct roles. The backend must expect and handle these exact string values (case-insensitive handling recommended, standardized to UPPERCASE in DB).

### A. Admin (Super Admin)
*   **Description**: Full system access. Responsible for user management, system configuration, and high-level oversight.
*   **Scope**: System-wide.

### B. Mapping Admin (Operational Manager)
*   **Description**: Responsible for the integrity of the Vehicle Master Data. They can create/edit internal vehicle hierarchy (Makes/Models) and have the final say on ADP Mappings (Approval/Rejection).
*   **Scope**: Vehicle Management, ADP Data, Mapping Operations.
*   **Restriction**: Cannot access System Configuration or User Management.

### C. Mapping User (Data Specialist)
*   **Description**: Operational staff responsible for linking ADP raw data to SlashData internal IDs. They perform the initial mapping work.
*   **Scope**: Read-only access to Master Data. Write access to Mapping links.
*   **Restriction**: Cannot create new internal Makes/Models. Cannot Approve/Reject mappings. Cannot access Admin features.

---

## 2. Permission Matrix

| Feature / Module | Action | Admin | Mapping Admin | Mapping User |
| :--- | :--- | :---: | :---: | :---: |
| **Authentication** | Login / Logout | ✅ | ✅ | ✅ |
| **System Config** | View / Edit AI Settings | ✅ | ❌ | ❌ |
| **User Mgmt** | View / Create / Edit / Delete Users | ✅ | ❌ | ❌ |
| **Activity Tracking**| View Global Logs | ✅ | ✅ | ❌ |
| **Internal Vehicles**| View Makes/Models/Types | ✅ | ✅ | ✅ |
| **Internal Vehicles**| Create/Edit/Delete Makes/Models | ✅ | ✅ | ❌ |
| **Internal Vehicles**| Bulk Import (CSV) | ✅ | ✅ | ❌ |
| **ADP Master** | View ADP Raw Data | ✅ | ✅ | ✅ |
| **ADP Master** | Upload/Edit ADP Data | ✅ | ✅ | ❌ |
| **Mapping** | View Mappings | ✅ | ✅ | ✅ |
| **Mapping** | Edit Mapping (Link ADP to SD) | ✅ | ✅ | ✅ |
| **Mapping** | Flag "Missing Model/Make" | ✅ | ✅ | ✅ |
| **Review** | **Approve** Mapping | ✅ | ✅ | ❌ |
| **Review** | **Reject** Mapping | ✅ | ✅ | ❌ |

---

## 3. Backend Implementation Logic

The Spring Boot backend must enforce security at the Controller/Endpoint level using Filters or Annotations (e.g., `@PreAuthorize`).

### 3.1 JWT Payload
When `POST /api/auth/login` is called, the returned JWT Token must contain the role claim.
*   **Payload Example**:
    ```json
    {
      "sub": "admin@slashdata.ae",
      "userId": 1,
      "role": "ADMIN", // or "MAPPING_ADMIN", "MAPPING_USER"
      "exp": 1714500000
    }
    ```

### 3.2 Endpoint Security Rules

1.  **Public Endpoints**:
    *   `POST /api/auth/login`

2.  **Admin Only (`hasRole('ADMIN')`)**:
    *   `/api/users/**`
    *   `/api/config/**`
    *   `/api/audit/full`

3.  **Manager Level (`hasAnyRole('ADMIN', 'MAPPING_ADMIN')`)**:
    *   `POST/PUT/DELETE /api/makes/**`
    *   `POST/PUT/DELETE /api/models/**`
    *   `POST/PUT/DELETE /api/types/**`
    *   `POST/PUT/DELETE /api/adp/master/**` (Uploads)
    *   `POST /api/adp/mappings/{id}/approve`
    *   `DELETE /api/adp/mappings/{id}/reject`
    *   `POST /api/adp/mappings/bulk-action`

4.  **Operational Level (`isAuthenticated()`)**:
    *   `GET /api/makes`, `GET /api/models` (Read-only)
    *   `GET /api/adp/master`
    *   `GET /api/adp/mappings`
    *   `PUT /api/adp/mappings/{id}` (Users can UPSERT a mapping proposal, but cannot change the `status` to APPROVED directly. The backend must force `reviewedAt = null` when a User updates a mapping).

### 3.3 Critical Business Logic (Mapping Workflow)

1.  **Mapping Update by User**:
    *   When a `Mapping User` submits a mapping (`PUT /api/adp/mappings/{id}`):
        *   Update `make_id` and `model_id`.
        *   Set `status` to `MAPPED` (or `MISSING_MODEL` if selected).
        *   **CRITICAL**: Set `reviewed_at` to `NULL` and `reviewed_by` to `NULL`.
        *   Log entry in `ADPMappingHistory`: `ACTION: UPDATED`.

2.  **Mapping Update by Admin**:
    *   Admins can perform the same action as above.
    *   Optionally, if they use the Approval endpoint, it sets `reviewed_at = NOW()`.

3.  **Missing Hierarchy**:
    *   If a `Mapping User` encounters a vehicle that doesn't exist in SlashData:
        *   They cannot create the Model.
        *   They must save the mapping with status `MISSING_MODEL` (and map the Make).
        *   A `Mapping Admin` filters the Review View by "Missing Model", creates the Model in the system, and then updates the mapping.

---

## 4. Frontend Alignment

The frontend `components/Layout.tsx` already hides navigation items based on these roles.
*   **Admin**: Sees "Administration" group.
*   **Mapping Admin**: Sees "Vehicle Management" and "ADP" groups.
*   **Mapping User**: Sees only "ADP" group (excluding "Mapping Review") and "Dashboard".

**Note**: The backend is the source of truth. Even if the frontend hides a button, the API endpoint must reject the request if an unauthorized user attempts to call it (e.g., via Postman).
