
-- Database Schema for SlashData Vehicle Portal
-- Database: MySQL 8.0+
-- ---------------------------------------------------------

-- 1. Users Table
CREATE TABLE Users (
    id VARCHAR(36) PRIMARY KEY, -- UUID
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL, -- BCrypt Hash
    role VARCHAR(20) NOT NULL, -- Enum handled by app logic or CHECK
    status VARCHAR(20) DEFAULT 'Active',
    last_active TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_user_role CHECK (role IN ('Admin', 'Mapping Admin', 'Mapping User')),
    CONSTRAINT chk_user_status CHECK (status IN ('Active', 'Inactive'))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2. Vehicle Types Table
CREATE TABLE VehicleTypes (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    name_ar VARCHAR(100),
    description TEXT,
    description_ar TEXT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 3. Makes Table
CREATE TABLE Makes (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    name_ar VARCHAR(100)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 4. Models Table
CREATE TABLE Models (
    id VARCHAR(36) PRIMARY KEY,
    make_id VARCHAR(36) NOT NULL,
    type_id VARCHAR(36) NOT NULL,
    name VARCHAR(100) NOT NULL,
    name_ar VARCHAR(100),
    FOREIGN KEY (make_id) REFERENCES Makes(id) ON DELETE CASCADE,
    FOREIGN KEY (type_id) REFERENCES VehicleTypes(id) ON DELETE RESTRICT,
    CONSTRAINT uc_models_make_name UNIQUE (make_id, name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 5. ADP Master Data Table
CREATE TABLE ADPMaster (
    id VARCHAR(36) PRIMARY KEY,
    adp_make_id VARCHAR(50),
    make_en_desc VARCHAR(200),
    make_ar_desc VARCHAR(200),
    adp_model_id VARCHAR(50),
    model_en_desc VARCHAR(200),
    model_ar_desc VARCHAR(200),
    adp_type_id VARCHAR(50),
    type_en_desc VARCHAR(200),
    type_ar_desc VARCHAR(200)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 6. ADP Mappings Table
-- Records represent "Proposed" or "Approved" mappings.
-- Rejection deletes the record.
CREATE TABLE ADPMappings (
    id VARCHAR(36) PRIMARY KEY,
    adp_id VARCHAR(36) NOT NULL UNIQUE,
    
    -- Mapping Targets
    status VARCHAR(50) DEFAULT 'MAPPED',
    model_id VARCHAR(36), -- Populated if MAPPED
    make_id VARCHAR(36),  -- Populated if MISSING_MODEL
    
    -- Audit & Review Workflow
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    updated_by VARCHAR(36),
    
    -- Review Columns: NULL = Pending, NOT NULL = Approved
    reviewed_at TIMESTAMP NULL DEFAULT NULL, 
    reviewed_by VARCHAR(36) DEFAULT NULL,

    -- Constraints
    CONSTRAINT chk_map_status CHECK (status IN ('MAPPED', 'MISSING_MAKE', 'MISSING_MODEL')),
    FOREIGN KEY (adp_id) REFERENCES ADPMaster(id) ON DELETE CASCADE,
    FOREIGN KEY (model_id) REFERENCES Models(id) ON DELETE SET NULL,
    FOREIGN KEY (make_id) REFERENCES Makes(id) ON DELETE SET NULL,
    FOREIGN KEY (updated_by) REFERENCES Users(id) ON DELETE SET NULL,
    FOREIGN KEY (reviewed_by) REFERENCES Users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 7. ADP Make Mappings Table
CREATE TABLE ADPMakeMappings (
    adp_make_id VARCHAR(50) NOT NULL PRIMARY KEY,
    sd_make_id VARCHAR(36) NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (sd_make_id) REFERENCES Makes(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Indexes for Performance
CREATE INDEX idx_models_make ON Models(make_id);
CREATE INDEX idx_adp_mapping_status ON ADPMappings(status);
CREATE INDEX idx_adp_mapping_updated ON ADPMappings(updated_at);
-- Review workflow index: fast lookup of pending items
CREATE INDEX idx_adp_mapping_pending ON ADPMappings(reviewed_at);
